# Интеграция бэкенда бота и сервера Whisper.cpp через API

В данном документе подробно описан процесс интеграции бэкенда Telegram-бота и сервера с Whisper.cpp. Интеграция будет осуществляться через **RESTful API**, что обеспечивает гибкость, масштабируемость и изоляцию компонентов системы.

---

## 1. Архитектурный подход

Система состоит из двух основных компонентов:

- **Бэкенд бота**:  
  Отвечает за взаимодействие с Telegram API, получение аудиосообщений от пользователей, их предварительную обработку и отправку результатов транскрипции обратно в Telegram.
- **Сервер Whisper.cpp**:  
  Отдельный сервис, развернутый на виртуальной машине, который предоставляет API для транскрипции аудиофайлов с использованием Whisper.cpp.

Компоненты взаимодействуют через RESTful API: бэкенд бота отправляет аудиофайлы на сервер Whisper.cpp и получает текстовые транскрипции.

---

## 2. API сервера Whisper.cpp

Сервер Whisper.cpp предоставляет API с конечной точкой для транскрипции аудио. Основная конечная точка:

### **POST /transcribe**
- **Входные данные**: Аудиофайл (передается в формате `multipart/form-data`).
- **Выходные данные**: JSON-объект с текстом транскрипции или сообщением об ошибке.
- **Пример запроса**:
  ```bash
  curl -X POST http://whisper-server-ip:port/transcribe -F "file=@audio.ogg"
  ```
- **Пример ответа**:
  ```json
  {
    "transcription": "Текст транскрипции аудио."
  }
  ```

---

## 3. Реализация сервера Whisper.cpp

- **Язык программирования**: C++ (используется Whisper.cpp).
- **Фреймворк**: Для создания HTTP-сервера можно использовать библиотеки, такие как `cpp-httplib` или `Crow`.
- **Процесс работы**:
  1. Сервер принимает POST-запрос с аудиофайлом.
  2. Сохраняет файл во временное хранилище на сервере.
  3. Выполняет транскрипцию с помощью Whisper.cpp.
  4. Формирует и отправляет ответ в формате JSON с текстом транскрипции.

---

## 4. Интеграция с бэкендом бота

- **Язык программирования**: Python (например, с использованием библиотеки `aiogram` для Telegram-бота).
- **Процесс работы**:
  1. Бот получает аудиосообщение от пользователя через Telegram API.
  2. Загружает аудиофайл с серверов Telegram.
  3. Отправляет файл на сервер Whisper.cpp через POST-запрос к конечной точке `/transcribe`.
  4. Получает ответ от сервера с текстом транскрипции.
  5. Отправляет текст транскрипции пользователю в Telegram.

- **Асинхронная очередь задач (Celery)**:
  - Использовать Celery с брокером RabbitMQ/Redis.
  - Реализовать `transcribe_audio` как Celery task.
  - Настроить retry, result backend и chain.

- **Пример кода на Python**:
  ```python
  import requests

  WHISPER_API_URL = "http://whisper-server-ip:port/transcribe"

  def transcribe_audio(file_path):
      with open(file_path, 'rb') as audio_file:
          files = {'file': audio_file}
          response = requests.post(WHISPER_API_URL, files=files)
          if response.status_code == 200:
              return response.json()['transcription']
          else:
              raise Exception("Ошибка транскрипции")
  ```

---

## 5. Развертывание

- **Сервер Whisper.cpp**:  
  Разворачивается на виртуальной машине (например, в Yandex Cloud). Для изоляции зависимостей и упрощения развертывания рекомендуется использовать Docker.
- **Бэкенд бота**:  
  Может быть развернут на той же виртуальной машине (если ресурсы позволяют) или на отдельной VM.
- **Сетевые настройки**:  
  Настраиваются сетевые правила, чтобы бэкенд бота мог обращаться к серверу Whisper.cpp по внутреннему IP-адресу.

---

## 6. Преимущества API-подхода

- **Изоляция**: Компоненты системы независимы друг от друга, что упрощает разработку, тестирование и обновление.
- **Масштабируемость**: При увеличении нагрузки можно добавить дополнительные экземпляры сервера Whisper.cpp.
- **Гибкость**: Сервер Whisper.cpp можно обновлять или заменять без изменений в бэкенде бота.
- **Безопасность**: Возможна настройка аутентификации (например, через API-ключи) для ограничения доступа к конечной точке.
  - **API-ключи**: Для доступа к /transcribe требуется уникальный ключ, который передаётся в заголовке X-API-Key и проверяется на сервере.

---

## 7. Рекомендации

- **Аутентификация**: Добавьте базовую аутентификацию или API-ключи для защиты конечной точки `/transcribe`.
  - Для каждого клиента генерируйте уникальный ключ, проверяйте его на сервере (например, через заголовок X-API-Key).
- **Логирование**: Ведите логи запросов и ошибок на сервере Whisper.cpp для мониторинга и отладки.
- **Обработка ошибок**: Реализуйте повторные попытки запросов и уведомления пользователей в случае сбоев.

---

## Вывод

Интеграция бэкенда бота и сервера Whisper.cpp через RESTful API — это оптимальное решение, которое обеспечивает гибкость, масштабируемость и надежность системы. Такой подход позволяет эффективно разделять обязанности компонентов и упрощает дальнейшую поддержку и развитие проекта.