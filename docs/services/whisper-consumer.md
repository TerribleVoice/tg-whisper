# Whisper Consumer

Воркер для обработки голосовых сообщений с использованием WhisperX модели.

## Функциональность

- Получение задач транскрипции из RabbitMQ очереди
- Загрузка голосовых файлов по URL
- Транскрипция с использованием WhisperX модели
- Отправка результатов в очередь результатов

## Технологии

- **dramatiq** - система очередей задач
- **httpx** - HTTP клиент для загрузки файлов
- **whisper-model** - собственная библиотека для транскрипции
- **tempfile** - работа с временными файлами

## Конфигурация

### Переменные окружения

- `TASK_QUEUE_NAME` - имя очереди для задач (обязательно)
- `RESULTS_QUEUE_NAME` - имя очереди для результатов (обязательно)
- `RABBITMQ_URL` - URL подключения к RabbitMQ (по умолчанию: `amqp://guest:guest@localhost:5672/`)
- `WHISPER_CONFIG_JSON_PATH` - путь к JSON конфигурации WhisperX (обязательно)

### Конфигурация WhisperX

Файл конфигурации содержит настройки для:
- **Whisper модели** - архитектура, device, языковые настройки
- **Выравнивания** - точное позиционирование слов
- **Сегментации** - разделение по спикерам

## Обработка задач

Actor `transcribe_audio_task` обрабатывает сообщения с параметрами:
- `file_url` - URL для загрузки голосового файла
- `chat_id` - ID чата для отправки результата
- `message_date` - дата сообщения

### Процесс обработки

1. **Загрузка файла** - через httpx с timeout 30 секунд
2. **Сохранение во временный файл** - с расширением `.oga`
3. **Транскрипция** - с использованием WhisperX модели
4. **Отправка результата** - в очередь результатов
5. **Очистка** - удаление временного файла

## Обработка ошибок

- **HTTP ошибки** - проблемы загрузки файла
- **Ошибки транскрипции** - проблемы с обработкой аудио
- **Общие исключения** - неожиданные ошибки

Все ошибки логируются и отправляются в очередь результатов.

## Запуск

```bash
# Запуск воркера
dramatiq whisper-consumer.main

# Или с указанием количества процессов
dramatiq whisper-consumer.main --processes 2
```

## Особенности

- Используется `AsyncIO` middleware для асинхронной работы
- Автоматическая очистка временных файлов в `finally` блоке
- Подробное логирование всех этапов обработки
- Поддержка различных форматов голосовых файлов (через librosa)
- Timeout для HTTP запросов предотвращает зависание 